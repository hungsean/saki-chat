name: Bundle Size Check

on:
  pull_request:
    branches: [main, develop]

jobs:
  bundle-size:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Analyze bundle size
        run: pnpm bundle-size

      - name: Check bundle size limits
        run: pnpm bundle-check

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: dist/stats.html
          retention-days: 30

      - name: Comment PR with bundle size
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const stats = JSON.parse(fs.readFileSync('dist/stats.json', 'utf8'));

            const totalSize = (stats.assets.reduce((acc, asset) => acc + asset.size, 0) / 1024 / 1024).toFixed(2);
            const jsSize = (stats.assets.filter(a => a.name.endsWith('.js')).reduce((acc, asset) => acc + asset.size, 0) / 1024 / 1024).toFixed(2);
            const cssSize = (stats.assets.filter(a => a.name.endsWith('.css')).reduce((acc, asset) => acc + asset.size, 0) / 1024 / 1024).toFixed(2);

            const comment = `## Bundle Size Report

            | Type | Size |
            |------|------|
            | Total | ${totalSize} MB |
            | JavaScript | ${jsSize} MB |
            | CSS | ${cssSize} MB |

            ${totalSize > 5 ? '⚠️ Warning: Bundle size exceeds 5MB' : '✅ Bundle size is within limits'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
